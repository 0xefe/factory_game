<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FACTORY_CHAIN: NEXUS â€” SUPREMACY</title>

    <!-- Yandex Games SDK -->
    <script src="https://yandex.ru/games/sdk/v2"></script>

    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Orbitron:wght@400;700;900&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg: #020408;
            --panel: #0a0c10;
            --accent: #ffaa00;
            --electric: #00f2ff;
            --research: #bc44ff;
            --danger: #ff0044;
            --text: #e0e6ed;
            --border: rgba(0, 242, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            outline: none;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'JetBrains Mono', monospace;
            overflow: hidden;
            display: flex;
            height: 100vh;
        }

        #sidebar {
            width: 360px;
            background: var(--panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 100;
            box-shadow: 15px 0 50px rgba(0, 0, 0, 0.8);
        }

        .header {
            padding: 25px;
            border-bottom: 1px solid var(--border);
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            color: var(--electric);
            letter-spacing: 3px;
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.02);
            padding: 12px;
            border-radius: 4px;
            border-left: 3px solid var(--electric);
        }

        .stat-lbl {
            font-size: 0.6rem;
            opacity: 0.4;
            text-transform: uppercase;
        }

        .stat-val {
            font-size: 1rem;
            font-weight: bold;
            font-family: 'Orbitron';
            margin-top: 4px;
        }

        .tabs {
            display: flex;
            background: rgba(0, 0, 0, 0.2);
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            font-size: 0.7rem;
            font-weight: bold;
            opacity: 0.4;
            transition: 0.3s;
        }

        .tab.active {
            opacity: 1;
            color: var(--accent);
            border-bottom: 2px solid var(--accent);
        }

        .content {
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto;
        }

        .card {
            background: rgba(255, 255, 255, 0.01);
            border: 1px solid var(--border);
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            border-radius: 4px;
        }

        .card:hover:not(.locked) {
            border-color: var(--electric);
            background: rgba(0, 242, 255, 0.05);
        }

        .card.active {
            border-color: var(--accent);
            background: rgba(255, 170, 0, 0.1);
        }

        .card.locked {
            opacity: 0.25;
            cursor: not-allowed;
        }

        #btn-reward {
            background: linear-gradient(90deg, #ffaa00, #ff4400);
            color: #000;
            font-weight: 900;
            border: none;
            padding: 12px;
            margin: 15px;
            cursor: pointer;
            border-radius: 4px;
            font-family: 'Orbitron';
            font-size: 0.65rem;
        }

        #viewport {
            flex-grow: 1;
            position: relative;
            background: #04060b;
            overflow: hidden;
        }

        #canvas {
            display: block;
        }

        #log {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 260px;
            pointer-events: none;
            display: flex;
            flex-direction: column-reverse;
            gap: 5px;
        }

        .msg {
            background: rgba(10, 12, 16, 0.9);
            padding: 8px 12px;
            font-size: 0.6rem;
            border-left: 3px solid var(--electric);
            border-radius: 2px;
        }

        #loading {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Orbitron';
        }

        .spin {
            width: 30px;
            height: 30px;
            border: 3px solid #111;
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: s 0.6s linear infinite;
        }

        @keyframes s {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <div id="loading">
        <div class="spin"></div>
        <p style="margin-top:15px; font-size:0.6rem; letter-spacing:3px;">SYSTEM BOOTING</p>
    </div>

    <aside id="sidebar">
        <div class="header">
            <h1>NEXUS SUPREMACY</h1>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-lbl">CREDITS</div>
                    <div class="stat-val" id="ui-cr">1,000</div>
                </div>
                <div class="stat-card" style="border-left-color: var(--research)">
                    <div class="stat-lbl">RESEARCH</div>
                    <div class="stat-val" id="ui-rp">0</div>
                </div>
            </div>
            <div class="stat-card" style="width:100%; margin-top:10px;">
                <div class="stat-lbl">POWER GRID (CON/GEN)</div>
                <div class="stat-val" id="ui-pwr">0/0</div>
            </div>
        </div>

        <button id="btn-reward" onclick="showAd()">ðŸ“º EMERGENCY RE-SUPPLY (+2000)</button>

        <div class="tabs">
            <div id="tab-build" class="tab active" onclick="switchTab('build')">CONSTRUCT</div>
            <div id="tab-res" class="tab" id="tab-res" onclick="switchTab('res')">RESEARCH</div>
        </div>

        <div class="content" id="panel-build"></div>
        <div class="content" id="panel-res" style="display:none"></div>
    </aside>

    <main id="viewport">
        <canvas id="canvas"></canvas>
        <div id="log"></div>
    </main>

    <script>
        // --- GLOBAL STATE ---
        let ysdk = null;
        const TILE = 64;
        let state = {
            cr: 1200, rp: 0, grid: {},
            selected: null, rot: 0,
            cam: { x: 0, y: 0, z: 0.8 },
            unlocked: ['SOLAR', 'MINER', 'BELT', 'SELLER', 'LAB'],
            lastTick: Date.now()
        };

        const MACHINES = {
            SOLAR: { id: 'SOLAR', name: 'Solar Cell', cost: 150, pwr: -60, icon: 'â˜€', color: '#00f2ff' },
            MINER: { id: 'MINER', name: 'Iron Miner', cost: 250, pwr: 30, icon: 'â›', color: '#f0ab00' },
            BELT: { id: 'BELT', name: 'Nexus Belt', cost: 10, pwr: 2, icon: 'âž”', color: '#333' },
            SMELTER: { id: 'SMELTER', name: 'Nano Forge', cost: 500, pwr: 100, icon: 'ðŸ”¥', color: '#ff4400' },
            TURRET: { id: 'TURRET', name: 'ARC Turret', cost: 700, pwr: 80, icon: 'ðŸ”«', color: '#ff0044' },
            SELLER: { id: 'SELLER', name: 'Sell Hub', cost: 300, pwr: 20, icon: 'ï¼„', color: '#00ff88' },
            LAB: { id: 'LAB', name: 'Research Lab', cost: 900, pwr: 150, icon: 'âš›', color: '#bc44ff' }
        };

        const TECHS = {
            FORGE: { id: 'FORGE', name: 'Advanced Forging', cost: 40, unlock: 'SMELTER', done: false },
            DEF: { id: 'DEF', name: 'Defense Logic', cost: 60, unlock: 'TURRET', done: false }
        };

        // --- SAFE INITIALIZATION ---
        window.onload = function () {
            console.log("Window loaded, checking SDK...");
            if (typeof YaGames !== 'undefined') {
                YaGames.init().then(_sdk => {
                    ysdk = _sdk;
                    console.log("Yandex SDK Ready");
                    ysdk.adv.showFullscreenAdv({ callbacks: { onClose: () => initGame(), onError: () => initGame() } });
                }).catch(e => { console.error(e); initGame(); });
            } else {
                console.warn("YaGames not defined. Standing by in offline mode.");
                initGame();
            }
        };

        function initGame() {
            document.getElementById('loading').style.display = 'none';
            setupEvents();
            resize();
            renderUI();
            requestAnimationFrame(frame);
            addLog("NEXUS ONLINE. READY FOR EXPANSION.");
        }

        // --- CORE LOOP ---
        function frame() {
            const now = Date.now();
            if (now - state.lastTick > 1000) { tick(); state.lastTick = now; }
            draw();
            requestAnimationFrame(frame);
        }

        function tick() {
            let gen = 0, cons = 0;
            for (let k in state.grid) {
                const m = state.grid[k];
                if (m.type === 'SOLAR') gen += 60; else cons += MACHINES[m.type].pwr;
            }
            const power = gen >= cons;
            updateStats(cons, gen);
            if (!power) return;

            for (let k in state.grid) {
                const m = state.grid[k]; const [x, y] = k.split(',').map(Number);
                if (m.type === 'LAB') state.rp += 1;
                if (m.type === 'MINER') transfer(x, y, m.rot, 'IRON');
                if (m.type === 'BELT' && m.items.length > 0) {
                    if (transfer(x, y, m.rot, m.items[0])) m.items.shift();
                }
                if (m.type === 'SMELTER' && m.items.length > 0) {
                    m.w = (m.w || 0) + 1;
                    if (m.w >= 3) { m.items.shift(); m.items.push('STEEL'); m.w = 0; }
                    if (m.items[0] === 'STEEL' && transfer(x, y, m.rot, 'STEEL')) m.items.shift();
                }
                if (m.type === 'SELLER' && m.items.length > 0) {
                    const item = m.items.shift();
                    state.cr += (item === 'STEEL' ? 250 : 50);
                }
            }
        }

        function transfer(x, y, rot, item) {
            let nx = x, ny = y;
            if (rot === 0) nx++; if (rot === 1) ny++; if (rot === 2) nx--; if (rot === 3) ny--;
            const f = state.grid[`${nx},${ny}`];
            if (f && f.items.length < 2) { f.items.push(item); return true; }
            return false;
        }

        function updateStats(c, g) {
            document.getElementById('ui-cr').innerText = Math.floor(state.cr).toLocaleString();
            document.getElementById('ui-rp').innerText = Math.floor(state.rp);
            document.getElementById('ui-pwr').innerText = `${c}/${g} kW`;
            document.getElementById('power-box').style.borderLeftColor = c > g ? 'var(--danger)' : 'var(--electric)';
        }

        // --- DRAWING ---
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function resize() {
            canvas.width = window.innerWidth - 360;
            canvas.height = window.innerHeight;
        }

        function draw() {
            ctx.fillStyle = '#020408'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.scale(state.cam.z, state.cam.z);
            ctx.translate(-state.cam.x, -state.cam.y);

            // Grid
            ctx.strokeStyle = '#0a0c10'; ctx.lineWidth = 1;
            for (let i = 0; i < 3000; i += TILE) { ctx.moveTo(i, 0); ctx.lineTo(i, 3000); ctx.moveTo(0, i); ctx.lineTo(3000, i); }
            ctx.stroke();

            // Machines
            for (let k in state.grid) {
                const m = state.grid[k]; const [x, y] = k.split(',').map(Number);
                ctx.save(); ctx.translate(x * TILE + TILE / 2, y * TILE + TILE / 2);
                ctx.fillStyle = MACHINES[m.type].color; ctx.rotate(m.rot * Math.PI / 2);
                ctx.fillRect(-24, -24, 48, 48);
                ctx.fillStyle = '#fff'; ctx.font = 'bold 20px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.rotate(-m.rot * Math.PI / 2); ctx.fillText(MACHINES[m.type].icon, 0, 0);
                if (m.items.length > 0) {
                    ctx.fillStyle = m.items[0] === 'IRON' ? '#888' : '#ff0';
                    ctx.beginPath(); ctx.arc(0, 0, 6, 0, 7); ctx.fill();
                }
                ctx.restore();
            }

            // Preview
            if (state.selected) {
                const gx = Math.floor((state.mx / state.cam.z + state.cam.x) / TILE);
                const gy = Math.floor((state.my / state.cam.z + state.cam.y) / TILE);
                ctx.globalAlpha = 0.25; ctx.fillStyle = MACHINES[state.selected].color;
                ctx.fillRect(gx * TILE, gy * TILE, TILE, TILE); ctx.globalAlpha = 1;
            }
            ctx.restore();

            // Movement
            if (keys['w']) state.cam.y -= 10; if (keys['s']) state.cam.y += 10;
            if (keys['a']) state.cam.x -= 10; if (keys['d']) state.cam.x += 10;
        }

        // --- UI & EVENTS ---
        function renderUI() {
            const b = document.getElementById('panel-build'); b.innerHTML = '';
            Object.values(MACHINES).forEach(m => {
                const c = document.createElement('div');
                c.className = `card ${state.unlocked.includes(m.id) ? '' : 'locked'} ${state.selected === m.id ? 'active' : ''}`;
                c.innerHTML = `<b>${m.icon} ${m.name}</b><br><small>${m.cost} CR</small>`;
                c.onclick = () => { if (state.unlocked.includes(m.id)) { state.selected = state.selected === m.id ? null : m.id; renderUI(); } };
                b.appendChild(c);
            });

            const r = document.getElementById('panel-res'); r.innerHTML = '';
            Object.values(TECHS).forEach(t => {
                const c = document.createElement('div');
                c.className = `card ${t.done ? 'active' : ''}`;
                c.innerHTML = `<b>${t.name}</b><br><small>${t.done ? 'DONE' : t.cost + ' RP'}</small>`;
                c.onclick = () => { if (!t.done && state.rp >= t.cost) { state.rp -= t.cost; t.done = true; state.unlocked.push(t.unlock); renderUI(); addLog("TECH UNLOCKED."); } };
                r.appendChild(c);
            });
        }

        function switchTab(t) {
            document.getElementById('tab-build').classList.toggle('active', t === 'build');
            document.getElementById('tab-res').classList.toggle('active', t === 'res');
            document.getElementById('panel-build').style.display = t === 'build' ? 'block' : 'none';
            document.getElementById('panel-res').style.display = t === 'res' ? 'block' : 'none';
        }

        function addLog(m) {
            const l = document.getElementById('log');
            const e = document.createElement('div'); e.className = 'msg'; e.innerText = `> ${m}`;
            l.appendChild(e); setTimeout(() => e.remove(), 4000);
        }

        function showAd() {
            if (!ysdk) { state.cr += 1000; updateStats(0, 0); addLog("DEV REWARD: +1000 CR"); return; }
            ysdk.adv.showRewardedVideo({ callbacks: { onRewarded: () => { state.cr += 2000; updateStats(0, 0); addLog("AD REWARD: +2000 CR"); } } });
        }

        const keys = {};
        function setupEvents() {
            window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
            window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);
            window.addEventListener('mousemove', e => { state.mx = e.offsetX; state.my = e.offsetY; });
            canvas.addEventListener('mousedown', e => {
                const gx = Math.floor((e.offsetX / state.cam.z + state.cam.x) / TILE);
                const gy = Math.floor((e.offsetY / state.cam.z + state.cam.y) / TILE);
                if (e.button === 0 && state.selected && state.cr >= MACHINES[state.selected].cost) {
                    state.cr -= MACHINES[state.selected].cost;
                    state.grid[`${gx},${gy}`] = { type: state.selected, rot: state.rot, items: [] };
                } else if (e.button === 2) delete state.grid[`${gx},${gy}`];
                renderUI();
            });
            window.addEventListener('keydown', e => { if (e.key === 'r') state.rot = (state.rot + 1) % 4; });
            window.oncontextmenu = e => e.preventDefault();
        }
    </script>
</body>

</html>